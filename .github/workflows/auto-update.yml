name: Auto Update

on:
  push:                      # Trigger on commits to main
    branches:
      - main
  schedule:
    - cron: '0 * * * *'      # Trigger every hour
  workflow_dispatch:         # Allow manual trigger from GitHub UI

permissions:
  contents: write  # Required for committing/pushing with GITHUB_TOKEN

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: 🛠 Set up Git user
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: 🔍 Confirm Python script exists
        run: |
          echo "Listing repo contents..."
          ls -lh
          echo "---"
          test -f briefcaseapp.py && echo "✅ briefcaseapp.py found" || echo "❌ briefcaseapp.py missing"

      - name: 🚀 Run CompactPaper script
        run: |
          echo "▶ Running briefcaseapp.py..."
          python3 briefcaseapp.py
          echo "✅ Script completed."

      - name: 🔎 Preview top of generated HTML
        run: |
          echo "Top of index.html:"
          head -n 20 index.html || echo "❌ index.html not found"

      - name: 🕒 Append update timestamp
        run: echo "Auto update: $(date +'%Y-%m-%d %H:%M:%S')" >> auto_update.txt

      - name: 📋 Git status and diff
        run: |
          echo "🔧 Git changes:"
          git status
          git diff || echo "⚠️ No diff to show"

      - name: 📤 Commit and push
        run: |
          git add .
          if git diff-index --quiet HEAD; then
            echo "🟡 No changes to commit"
          else
            git commit -m "Auto update: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
